import"./modulepreload-polyfill-B5Qt9EMX.js";import{$ as o,g as k,d as v,w as p,a as m,f as T,M as d,s as u,e as A}from"./widev-ClXCCnou.js";import{j as h,a as f,d as c,g as R,q as I,c as P,w as F,k as $,i as E,u as x,m as j,s as D,b as U,n as S,p as z}from"./init-ckCATEbZ.js";const s={colUsuarios:"smiles",colConfig:"configuracion",keyAuthIn:"wiAuthIn",keyAuthRol:"wiAuthRol",rolDefault:"smile",temaDefault:"Cielo",registroActivo:"no"};let L=!1,N=!1,y=s.temaDefault;o(()=>{const e=k(s.keyAuthIn),a=k(s.keyAuthRol);if(e==="wIn"&&a){v(a);return}});const g=(e,a)=>{o(e).removeClass("active").addClass("hidden"),o(a).removeClass("hidden").addClass("active")};o(".olvidastePass").click(e=>{e.preventDefault(),g(".login-form",".recovery-form")});o(".volverLogin").click(e=>{e.preventDefault(),g(".recovery-form, .registro-form",".login-form")});o(".crearCuenta").click(e=>{e.preventDefault(),g(".login-form",".registro-form")});o(".conCuenta").click(e=>{e.preventDefault(),g(".registro-form",".login-form")});o(".toggle-password").click(function(e){e.preventDefault();const a=o("#"+o(this).data("target"));a.attr("type",a.attr("type")==="password"?"text":"password"),o(this).find("i").toggleClass("fa-eye fa-eye-slash")});o("#email, #recEmail, #regEmail, #regUsuario").on("input",function(){o(this).val(o(this).val().toLowerCase().trim())});[["#password","#Login"],["#regPassword1","#Registrar"],["#recFechaNacimiento","#Recuperar"]].forEach(([e,a])=>{o(e).on("keyup",r=>r.key==="Enter"&&o(a).click())});const M={regEmail:[e=>e.toLowerCase(),e=>/^[\w-]+(\.[\w-]+)*@([\w-]+\.)+[a-zA-Z]{2,7}$/.test(e)||"Correo inválido"],regUsuario:[e=>e.toLowerCase().replace(/[^a-z0-9_]/g,""),e=>e.length>=3||"Usuario 3-20 caracteres"],regNombre:[e=>e.trim(),e=>e.length>0||"Ingrese nombre"],regApellidos:[e=>e.trim(),e=>e.length>0||"Ingrese apellidos"],regGenero:[e=>e,e=>["femenino","masculino"].includes(e)||"Selecciona género"],regFechaNacimiento:[e=>e,e=>A(e)>=13||"Mayor de 13 años requerido"],regPassword:[e=>e,e=>e.length>=6||"Mínimo 6 caracteres"],regPassword1:[e=>e,e=>e===o("#regPassword").val()||"Contraseñas no coinciden"]};o.each(M,(e,[a,r])=>{o(`#${e}`).on("blur change",function(){const t=a(o(this).val());o(this).val(t);const i=r(t);i!==!0&&p(this,i,"error")})});o("#regUsuario").on("blur",async function(){const e=o(this).val();if(e.length>=3)try{const a=await h(f(c,s.colUsuarios,e));L=!a.exists(),p(this,`Usuario ${a.exists()?"no disponible":"disponible ✅"}`,a.exists()?"error":"success","top",7e3)}catch(a){console.error(a)}});o("#regEmail").on("blur",async function(){const e=o(this).val();if(e.length>=3)try{const a=await R(I(P(c,s.colUsuarios),F("email","==",e)));N=a.empty,p(this,`Email ${a.empty?"disponible ✅":"no disponible"}`,a.empty?"success":"error","top",7e3)}catch(a){console.error(a)}});o("#Registrar").click(async function(){const e=[[L,o("#regUsuario")[0],"Usuario no disponible"],[N,o("#regEmail")[0],"Email no disponible"],...Object.entries(M).map(([a,[r,t]])=>{const i=o(`#${a}`),n=r(i.val()),l=t(n);return[l===!0,i[0],l!==!0?l:""]})];for(const[a,r,t]of e)if(!a&&t){p(r,t,"error"),r.focus();return}m(!0);try{const[a,r,t,i,n,l]=["regEmail","regUsuario","regNombre","regApellidos","regGenero","regPassword"].map(q=>o("#"+q).val().trim()),C={masculino:["Cielo|#0EBEFF","Paz|#29C72E"],femenino:["Dulce|#FF5C69","Mora|#7000FF"]},b=C[n]||C.masculino;y=b[Math.floor(Math.random()*b.length)];const{user:w}=await $(E,a,l);await Promise.all([x(w,{displayName:r}),j(w)]),await D(f(c,s.colUsuarios,r),{usuario:r,email:a,nombre:t,apellidos:i,genero:n,rol:s.rolDefault,fechaNacimiento:T(o("#regFechaNacimiento").val()),creacion:U(),participa:"si",imagen:"",descripcion:"",uid:w.uid}),await D(f(c,s.colConfig,r),{usuario:r,email:a,tema:y,actualizacion:U()}),d("Registro completado! ✅")}catch(a){d({"auth/email-already-in-use":"Email ya registrado","auth/weak-password":"Contraseña muy débil"}[a.code]||a.message,"error"),console.error(a)}finally{m(!1),u(s.keyAuthIn,"wIn",24),u(s.keyAuthRol,s.rolDefault,24),u("wiTema",y,72),setTimeout(()=>v(s.rolDefault),3e3)}});o("#Login").click(async function(){m(!0);try{const[e,a]=["#email","#password"].map(l=>o(l).val().trim());if(!e||!a)throw new Error("Completa todos los campos");let r=e,t=null,i=null;if(!e.includes("@")){if(t=await h(f(c,s.colUsuarios,e)),!t.exists())throw new Error("Usuario no encontrado");r=t.data().email;try{i=(await h(f(c,s.colConfig,e))).data()?.tema}catch{}}await S(E,r,a);const n=t?.data()?.rol||s.rolDefault;u(s.keyAuthIn,"wIn",24),u(s.keyAuthRol,n,24),i&&u("wiTema",i,72),d("¡Bienvenido! ✅"),setTimeout(()=>v(n),1500)}catch(e){d({"auth/invalid-credential":"Contraseña incorrecta","auth/invalid-email":"Email no registrado","auth/user-not-found":"Usuario no encontrado"}[e.code]||e.message,"error"),console.error(e)}finally{m(!1)}});o("#Recuperar").click(async function(){m(!0);try{const[e,a]=["#recEmail","#recFechaNacimiento"].map(n=>o(n).val().trim());if(!e||!a)throw new Error("Completa todos los campos");if(A(a)<13)throw new Error("Mayor de 13 años requerido");const r=e.includes("@")?e:await(async()=>{const n=await h(f(c,s.colUsuarios,e));return n.exists()?n.data().email:null})();if(!r)throw new Error("Usuario no registrado");const t=await R(I(P(c,s.colUsuarios),F("email","==",r)));if(t.empty)throw new Error("Email incorrecto");if(t.docs[0].data().fechaNacimiento.toDate().toISOString().split("T")[0]!==a)throw new Error("Fecha de nacimiento incorrecta");await z(E,r),d("Correo enviado. Revisa tu bandeja o spam ✅","success"),setTimeout(()=>g(".recovery-form",".login-form"),2e3)}catch(e){d(e.message,"error"),console.error(e)}finally{m(!1)}});
